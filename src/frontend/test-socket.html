<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Socket.IO</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>🧪 Test de Socket.IO</h1>
    
    <div>
        <button onclick="testConnection()">1. Test Conexión</button>
        <button onclick="testCreateSession()">2. Test Crear Sesión</button>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <h3>Logs:</h3>
    <div id="logs"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        const logsDiv = document.getElementById('logs');

        function addLog(message, type = 'info') {
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(log, logsDiv.firstChild);
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        function testConnection() {
            addLog('Iniciando test de conexión...', 'info');
            
            socket = io();

            socket.on('connect', () => {
                addLog('✅ Socket.IO CONECTADO - ID: ' + socket.id, 'success');
            });

            socket.on('disconnect', () => {
                addLog('❌ Socket.IO desconectado', 'error');
            });

            socket.on('connect_error', (error) => {
                addLog('❌ Error de conexión: ' + error.message, 'error');
            });

            // Escuchar TODOS los eventos
            socket.onAny((eventName, ...args) => {
                addLog('📡 Evento recibido: ' + eventName + ' - ' + JSON.stringify(args), 'info');
            });

            addLog('Socket.IO inicializado', 'info');
        }

        function testCreateSession() {
            if (!socket || !socket.connected) {
                addLog('❌ Primero conecta el socket (botón 1)', 'error');
                return;
            }

            const testSessionId = 'test_session_' + Date.now();
            addLog('Enviando solicitud de sesión: ' + testSessionId, 'info');

            // Escuchar eventos específicos de esta sesión
            socket.on(`qr-${testSessionId}`, (data) => {
                addLog('🎯 QR RECIBIDO! sessionId: ' + data.sessionId, 'success');
                addLog('QR length: ' + data.qr.length + ' caracteres', 'info');
                
                // Mostrar los primeros caracteres del QR
                addLog('QR data: ' + data.qr.substring(0, 100) + '...', 'info');
            });

            socket.on(`ready-${testSessionId}`, (data) => {
                addLog('✅ Dispositivo conectado!', 'success');
            });

            socket.on(`authenticated-${testSessionId}`, (data) => {
                addLog('✅ Autenticado!', 'success');
            });

            socket.on('session-created', (data) => {
                addLog('✅ Sesión creada: ' + JSON.stringify(data), 'success');
            });

            socket.on('session-error', (data) => {
                addLog('❌ Error en sesión: ' + data.message, 'error');
            });

            // Emitir evento
            socket.emit('create-session', {
                sessionId: testSessionId,
                userId: 1,
                deviceId: 999
            });

            addLog('📤 Evento create-session enviado', 'info');
        }

        // Auto-iniciar conexión
        window.onload = () => {
            addLog('Página cargada. Click en "Test Conexión" para empezar', 'info');
        };
    </script>
</body>
</html>

